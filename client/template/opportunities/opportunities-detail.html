<template name="opportunityDetail">
  {{#with oppData}}
  {{setPageTitle "Opportunity - " name}}
  <div class="row">
    <div class="col-md-12">
      <div class="pull-right hidden-xs">
        {{#if isActive}}
          <br>
          {{#if isInRole 'CanEditOpportunities'}}
            {{#if isNotFirstStage}}
              <button class="btn btn-default" id="previous-stage"><i class="fa fa-fw fa-chevron-left"></i> Back to previous stage</button>
            {{/if}}
            {{#if isLastStage}}
              <button class="btn btn-success" id="won-opportunity">Opportunity won</button>
            {{else}}
              <button class="btn btn-primary" id="next-stage">Move to next stage <i class="fa fa-fw fa-chevron-right"></i></button>
            {{/if}}
            <br><br>
            <a href="#" id="lost-opportunity" class="pull-right text-danger" style="text-decoration:underline">Mark opportunity as lost</a>
          {{/if}}
        {{else}}
          {{#if hasBeenWon}}
            <h3 class="text-success" style="margin-top: 25px;">Opportunity won</h3>
            {{#if isInRole 'CanReadProjects'}}
              {{#if projectId}}
                <p class="text-right"><a href="{{pathFor route='project' id=projectId}}">View project</a></p>
              {{/if}}
            {{/if}}
          {{else}}
            <br>
            <h3 class="text-danger">Opportunity lost</h3>
            <p class="text-right">{{reasonLost}}</p>
          {{/if}}
        {{/if}}
      </div>
      <h4 class="entity-title">Opportunity {{> watchlistAdmin entityData=this collection="opportunities"}}</h4>
      <h1 class="entity-name">{{name}}</h1>
      {{#if isActive}}
        <div class="stepwizard hidden-xs">
          <div class="stepwizard-row">
            {{#each stages}}
              {{> opportunityStage}}
            {{/each}}
          </div>
        </div>
        <br>
      {{/if}}

      <div class="clearfix"></div>

      {{> tagInput tags=tags collection='opportunities' entityId=_id permissionToEdit='CanEditOpportunities'}}

      <div class="panel panel-default" id="opportunity-details">
        <div class="panel-heading">
          {{#if isActive}}
            <div class="btn-group pull-right">
              {{#if isInRole 'CanEditOpportunities'}}
                <div class="btn-group">
                  <button type="button" class="btn btn-warning btn-xs dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span> Extract to...
                  </button>
                  <ul class="dropdown-menu" role="menu">
                    {{#if canExportDocx}}
                      <li><a href="#" id="template-upload-link-docx">Microsoft Word (.docx)</a></li>
                    {{/if}}
                    <li><a href="#" id="template-upload-link">PDF (.pdf)</a></li>
                    <!-- <li><a href="#" id="template-google-drive-link">Google Drive file</a></li> -->
                    <li class="divider"></li>
                    <li><a href="#" id="opp-template-help">How does this work?</a></li>
                  </ul>
                </div>
                {{#unless isMobile}}
                <button id="edit-opportunity" class="btn btn-info btn-xs"><i class="fa fa-fw fa-pencil"></i> Edit</button>
                {{/unless}}
              {{/if}}
              {{#if isInRole 'CanDeleteOpportunities'}}
                <button id="remove-opportunity" class="btn btn-danger btn-xs"><i class="fa fa-fw fa-times"></i> Delete</button>
              {{/if}}
            </div>
            <input type="file" id="template-upload-docx" style="height:0; width: 0; margin-left: -9999px">
            <input type="file" id="template-upload" style="height:0; width: 0; margin-left: -9999px">
          {{else}}
            {{#if isInRole 'CanEditOpportunities'}}
              {{#unless hasBeenWon}}
                <button id="reopen-opportunity" class="btn btn-info btn-xs pull-right"><i class="fa fa-fw fa-repeat"></i> Reopen</button>
              {{/unless}}
            {{/if}}
          {{/if}}
          Opportunity details
        </div>
        <ul class="list-group">
          <li class="list-group-item panel-item-header">
            <h4><i class="fa fa-fw fa-file-o"></i> Name</h4>
            {{name}}
          </li>
          <li class="list-group-item panel-item-header">
            <h4><i class="fa fa-fw fa-align-left"></i> Description</h4>
            {{description}}
          </li>
          <li class="list-group-item panel-item-header">
            <h4><i class="fa fa-fw fa-calendar"></i> Date</h4>
            {{friendlyDate}}
          </li>
          {{#if estCloseDate}}
          <li class="list-group-item panel-item-header">
            <h4><i class="fa fa-fw fa-calendar"></i> Estimated Close</h4>
            {{friendlyClose}}
          </li>
          {{/if}}
          {{#if value}}
            <li class="list-group-item panel-item-header">
              <h4><i class="fa fa-fw fa-money"></i> Value</h4>
              {{decimal value}}
            </li>
          {{/if}}

          {{#if isInRole 'CanReadCompanies'}}{{#if company}}
            <a href="{{pathFor route='company' id=company._id}}" class="list-group-item panel-item-header">
              <h4><i class="fa fa-fw fa-building"></i> Company</h4>
              <i class="fa fa-fw fa-chevron-right pull-right"></i>
               {{company.name}}
            </a>
          {{/if}}{{/if}}

          {{#if isInRole 'CanReadContacts'}}{{#if contact}}
            <a href="{{pathFor route='contact' id=contact._id}}" class="list-group-item panel-item-header">
              <h4><i class="fa fa-fw fa-user"></i> Contact</h4>
              <i class="fa fa-fw fa-chevron-right pull-right"></i>
               {{contact.name}}
            </a>
          {{/if}}
          {{#if salesManagerId}}
            <li class="list-group-item panel-item-header">
              <h4><i class="fa fa-fw fa-user-secret"></i> Sales Manager</h4>
              {{salesManager}}
            </li>
          {{/if}}
          {{/if}}
          <li class="list-group-item panel-item-header">
            <h4><i class="fa fa-fw fa-hashtag"></i> RealTime Opportunity ID</h4>
            <p class="list-group-item-text">{{sequencedIdentifier}}</p>
          </li>
        </ul>
      </div>
      <div class="panel panel-default" id="lines">
        <div class="panel-heading">
          Line items
          {{#if isActive}}
          <div class="pull-right">

            {{#if isInRole 'CanEditOpportunities'}}
            <button class="btn btn-primary btn-xs" id="add-line-item"><i class="fa fa-fw fa-plus"></i> Add line item</button>
            {{/if}}
          </div>
          {{/if}}
        </div>
        <ul class="list-group">
          {{#if items}}
            {{#each getItems}}
              {{> opportunityItem}}
            {{/each}}
          {{else}}
            <li class="list-group-item" id="no-line-items">
              No line items
            </li>
          {{/if}}
        </ul>
        {{#if items}}
          <div class="panel-footer">
            <b>Overall value</b>: {{decimal overallValue}}
          </div>
        {{/if}}
      </div>

{{> documentContainer collectionName="opportunities" id=this._id permissionRequired="CanEditOpportunities"}}

      {{#if isInRole 'CanReadTasks'}} {{#with this}} {{> taskDisplay entity_type="opportunity" entity_id=_id}} {{/with}} {{/if}}
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <h1 id="activity-timeline">
        Activity Timeline
        {{#if isActive}}
          <a class="btn btn-primary{{#unless isMobile}} pull-right{{/unless}}" data-toggle="tooltip" data-placement="bottom" title="New activity for this opportunity" href="#" id="add-activity"><i class="fa fa-fw fa-plus"></i> Add
            activity</a>
        {{/if}}
      </h1>
      {{> activityTimeline activities=activities}}
    </div>
  </div>
  {{#if isActive}}
    {{#if isInRole 'CanEditOpportunities'}}
      {{#if isMobile}}
        <div class="fab edit" id="fab">
          <i class="fa fw-fa fa-pencil"></i>
        </div>
      {{/if}}
    {{/if}}
  {{/if}}
  {{/with}}
</template>

<template name="opportunityStage">
  <div class="stepwizard-step {{#if isCurrentStep}}active-step{{/if}}" data-toggle="tooltip" data-placement="bottom" title="{{description}}">
    <button type="button" class="btn btn-default btn-circle" disabled="disabled"></button>
    <p>{{title}}</p>
  </div>
</template>

<template name="opportunityItem">
  <li class="list-group-item">
    {{#if isActive}}
    <div class="btn-group pull-right">
      <button class="btn btn-info btn-xs edit-line-item"><i class="fa fa-fw fa-pencil"></i> Edit</button>
      <button class="btn btn-danger btn-xs delete-line-item"><i class="fa fa-fw fa-times"></i> Delete</button>
    </div>
    {{/if}}
    <h4 style="margin: 0 0 4px">{{data.name}}</h4>
    {{#if data.description}}
      {{data.description}}<br>
    {{/if}}
    {{#if data.value}}
      <b>Value:</b> {{decimal data.value}}<br>
    {{/if}}
    {{#if data.quantity}}
      <b>Quantity:</b> {{data.quantity}}<br>
    {{/if}}
    {{#if totalValue}}
      <b>Total:</b> {{decimal totalValue}}
    {{/if}}
  </li>
</template>

<template name="oppHelpModal">
  <div class="modal fade" id="draggableModal" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
          <h4>Help on templates</h4>
        </div>
        <div class="modal-body">
          <p>Start by creating a Microsoft Word Document or PDF to act as a template. Include the keywords below where needed in the document, and select "Microsoft Word Template" or "PDF". In the file finder, select the template file you just created. RealTime will replace the keywords with their relative values, and download a new version of the file for you.</p>
          <p>Keywords which are recognised by RealTime:</p>
          <ul>
            <li>{opportunityName} - Opportunity name</li>
            <li>{opportunityDescription} - Opportunity description</li>

            <li>{companyName} - Company name (if provided)</li>
            <li>{companyAddress} - Address of company (if provided)</li>
            <li>{contactName} - Company contact name (if provided)</li>

            <li>{date} - The date that the template is generated on</li>
          </ul>

          For each line item, you can specify the following tags:
          <ul>
            <li>{name} - The name of the opportunity</li>
            <li>{description} - The description of the opportunity</li>
            <li>{value} - The value of the opportunity</li>
            <li>{quantity} - The quantity of the opportunity</li>
          </ul>
          You can loop through multiple items in your template by wrapping them as follows:
          <blockquote>
            {#lineItems} {name} {count} {value} {total} {/lineItems}
          </blockquote>
          <br /> All calculations are carried out by RealTime, so you don't need to do anything extra to generate a quotation.
        </div>
      </div>
    </div>
  </div>
</template>
