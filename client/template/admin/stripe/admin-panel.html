<template name="stripeAdmin">
  {{#unless hasStripeAccount}}{{#unless isProTenant}}
    <div class="settings-section">
      <h4>Upgrade RealTimeCRM</h4>
      <p>Subscribe to the Pro Plan to add more than 2 users.</p>
      <ul>
        <li><strong>Fixed price for life</strong> – The price you see is the price you will pay per user for the lifetime of your account;</li>
        <li><strong>No hidden costs</strong> – We will not make any additional charges for using the system or for support;</li>
        <li><strong>No contract</strong> – You can cancel your service at any time without incurring cancellation fees</li>
        <li><strong>No cost to&nbsp;switch</strong> – You can switch from one plan to another without incurring any switching costs.</li>
      </ul>
      <br>
      <p><button id="upScheme" class="btn btn-success"><i class="fa fa-fw fa-check"></i> Upgrade to the Pro Plan</button></p>
    </div>
  {{/unless}}{{/unless}}

  {{#if subscriptionCancelled}}
    <div class="settings-section">
      <h4>Resume Subscription </h4>
      <p>The subscription for {{tenantName}} has been cancelled. You can resume it until the end of that period.</p>
      <button id="resumeSubs" class="btn btn-success"><i class="fa fa-fw fa-check"></i> Resume subscription</button>
    </div>    
  {{/if}}

  {{#if hasStripeAccount}}
  <div class="settings-section">
    <h4>Overview</h4>
    {{#if subsLoaded}}
      <ul class="list-group">
        <li class="list-group-item panel-item-header">
          <h4 class="slim"><i class="fa fa-fw fa-wrench"></i> Plan</h4>
          {{currentSubscription}} - {{totalUsers}} users
        </li>

        <!-- COUPON -->
        <li class="list-group-item panel-item-header">
          <h4 class="slim">
            <i class="fa fa-fw fa-ticket"></i> Coupon
            {{#unless isProTenant}}<button id="updateCoupon" class="btn btn-xs btn-primary pull-right">Update Coupon</button>{{/unless}}
          </h4>
          {{#if couponLoaded}}
            {{#if hasCoupon}}{{hasCoupon}}{{else}}No active coupon{{/if}}
          {{else}}
            <em><i class="fa fa-circle-o-notch fa-spin"></i> Loading...</em>
          {{/if}}
        </li>

        <!-- INVOICE EMAIL ADDRESS -->
        <li class="list-group-item panel-item-header">
          <h4 class="slim">
            <i class="fa fa-fw fa-envelope-o"></i> Invoice Email Address
            <button id="updateEmail" class="btn btn-xs btn-primary pull-right">Update Email</button>
          </h4>
          {{#if stripeCustomer.email}}
            {{stripeCustomer.email}}
          {{else}}
            <em><i class="fa fa-circle-o-notch fa-spin"></i> Loading...</em>
          {{/if}}
        </li>

        <!-- CARD DETAILS -->
        <li class="list-group-item panel-item-header">
          <h4 class="slim">
            <i class="fa fa-fw fa-credit-card"></i> Card Details 
            <button id="updateCardDetails" class="btn btn-xs btn-primary pull-right">Update Card Details</button>
          </h4>
          {{#if stripeCustomer.sources.total_count}}{{#with cardDetails}}{{#if cardDetails.last4}}
            <small>Number: </small> **** **** **** {{last4}} <br>
            <small>Expiration Date: </small> {{exp_month}} / {{exp_year}} <br>
            <small>Type: </small> {{brand}} <br>
            <small>Cardholder Name: </small> {{name}}
          {{else}}
            <em><i class="fa fa-circle-o-notch fa-spin"></i> Loading...</em>
          {{/if}}{{/with}}{{/if}}
        </li>
      </ul>
      <p>
        <a href="#" id="showStripeHow"><i class="fa fa-lock"></i> All payments are securely processed by Stripe, our payment partner</a>
      </p>
    {{else}}
      <em><i class="fa fa-circle-o-notch fa-spin"></i> Loading...</em>
    {{/if}}
  </div>
  {{/if}}

  {{#if hasStripeAccount}}

    {{#if hasUpcomingInvoice}}
    <div class="settings-section">
      <h4>Next Payment Due</h4>
      {{#if upcomingInvoice.date}}
        <p>The next payment for {{tenantName}} is {{upcomingInvoice.amount_due}} and is due on {{upcomingInvoice.date}}. See below for the cost breakdown.</p>
        <div class="panel panel-default">
          <table class="table panel-body">
            <tbody>
              {{#each upcomingInvoice.lines.data}}
                <tr>
                  <td>
                    {{description}}
                    {{#if quantity}}<br><small>{{quantity}} users on {{plan.name}} at {{plan.amount}} each - <a href="users">View users</a></small>{{/if}}
                  </td>
                  <td>{{amount}}</td>
                </tr>
              {{/each}}
              <tr>
                <td>Tax at {{upcomingInvoice.tax_percent}}%</td>
                <td>{{upcomingInvoice.tax}}</td>
              </tr>
              <tr class="active">
                <td>Total</td>
                <td>{{upcomingInvoice.amount_due}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      {{else}}
        <em><i class="fa fa-circle-o-notch fa-spin"></i> Loading...</em>
      {{/if}}
    </div>
    {{/if}}

    {{#if hasLastInvoice}}
    <div class="settings-section">
      <h4>Last Payment</h4>
      {{#if lastInvoice.date}}
        <p>The previous payment of {{lastInvoice.amount_due}} for {{tenantName}} was paid on {{lastInvoice.date}}. See below for the cost breakdown.</p>
        <div class="panel panel-default">
          <table class="table panel-body">
            <tbody>
              {{#each lastInvoice.lines.data}}
                <tr>
                  <td>
                    {{description}}
                    {{#if quantity}}<br><small>{{quantity}} users on {{plan.name}} at {{plan.amount}} each </small>{{/if}}
                  </td>
                  <td>{{amount}}</td>
                </tr>
              {{/each}}
              <tr>
                <td>Tax at {{lastInvoice.tax_percent}}%</td>
                <td>{{lastInvoice.tax}}</td>
              </tr>
              <tr class="active">
                <td>Total</td>
                <td>{{lastInvoice.amount_due}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      {{else}}
        <em><i class="fa fa-circle-o-notch fa-spin"></i> Loading...</em>
      {{/if}}
    </div>
    {{/if}}

  {{/if}}

  {{#if isProTenant}}{{#if hasStripeAccount}}
  <div class="settings-section">
    <h4 class="text-danger">Downgrade RealTimeCRM</h4>
    <p>You can downgrade to the Free Plan at any time, but {{tenantName}} will <strong>no longer</strong> have access to any data created with Pro Plan only functionality.</p>
    <p>Need to talk to us? Contact us - we'd love to help.</p>
    <small><a id="downScheme" class="text-danger" style="text-decoration:underline">Unsubscribe from the Pro Plan</a></small>
  </div>
  {{/if}}{{/if}}

</template>

<template name="lineDetails">
  {{#if amount}}
    <div class="row">
      <div class="col-xs-3"></div>
      <div class="col-xs-2"><em>{{amount}}</em></div>
      <div class="col-xs-7"><em>{{#if description}}{{description}}{{else}}Subscription for next period ({{period.start}} - {{period.end}}){{/if}}</em></div>
    </div>
  {{/if}}
</template>