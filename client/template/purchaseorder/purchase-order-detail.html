<template name="purchaseOrderDetail">
  {{#with purchaseOrderData}}
    {{setPageTitle "Purchase order - " description}}
    <div class="row">
      <div class="col-md-12">
        <h4 class="entity-title">Purchase Order {{#if sequencedIdentifier}}#{{sequencedIdentifier}}{{/if}} {{> watchlistAdmin entityData=this collection="purchaseorders"}}</h4>
        <h1 class="entity-name" id="purchase-order-details">{{description}}</h1>
        <div id="company-details-tags">
        {{> tagInput tags=tags collection='purchaseorders' entityId=_id permissionToEdit='CanEditPurchaseOrders'}}
       </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <div class="btn-group pull-right">
              {{#if isInRole 'CanEditPurchaseOrders'}}
              <div class="btn-group">
                <button class="btn btn-warning btn-xs dropdown-toggle" data-toggle="dropdown" type="button">
                  <span class="caret"></span>
                  Extract to...
                </button>
                <ul class="dropdown-menu" role="menu">
                  {{#if canExportDocx}}
                    <li>
                      <a href="#" id="template-upload-link-docx">Word document (.docx)</a>
                    </li>
                  {{/if}}
                  <li class="divider"></li>
                  <li>
                    <a href="#" id="po-template-help">How does this work?</a>
                  </li>
                </ul>
              </div>
              {{#unless isMobile}}
                <a class="btn btn-info btn-xs" disabled="{{#unless isOpen}}disabled{{/unless}}" href="#" id="edit-purchase-order"><i class="fa fa-fw fa-pencil"></i>Edit</a>
              {{/unless}}
              {{/if}}
              {{#if isInRole 'CanDeletePurchaseOrders'}}
                <a class="btn btn-danger btn-xs" href="#" id="remove-purchase-order"><i class="fa fa-fw fa-times"></i>Delete</a>
              {{/if}}
            </div>
            <input id="template-upload-docx" style="height:0; width: 0; margin-left: -9999px" type="file">
            <input id="template-upload" style="height:0; width: 0; margin-left: -9999px" type="file">
            Details</div>
          <ul class="list-group">
            {{#if supplierCompany}}
              {{#if isInRole 'CanReadCompanies'}}
                <a class="list-group-item" data-placement="bottom" data-toggle="tooltip" href="{{pathFor route='company' id=supplierCompany._id}}" title="Navigate to supplier company details">
                  <i class="fa fa-fw fa-building"></i>
                  Supplier:
                  {{supplierCompany.name}}
                  <i class="fa fa-fw fa-chevron-right pull-right"></i>
                </a>
              {{/if}}
            {{/if}}
            {{#if supplierContact}}
              {{#if isInRole 'CanReadContacts'}}
                <a class="list-group-item" data-placement="bottom" data-toggle="tooltip" href="{{pathFor route='contact' id=supplierContact._id}}" title="Navigate to supplier contact details">
                  <i class="fa fa-fw fa-user"></i>
                  Supplier Contact:
                  {{supplierContact.forename}}
                  {{supplierContact.surname}}
                  <i class="fa fa-fw fa-chevron-right pull-right"></i>
                </a>
              {{/if}}
            {{/if}}

            <li class="list-group-item">
              <i class="fa fa-fw fa-question"></i>
              Status:
              {{status}}
            </li>
            <li class="list-group-item">
              <i class="fa fa-fw fa-calendar"></i>
              Order Date:
              {{formatDateLocale orderDate 'GMT'}}
            </li>
            <li class="list-group-item">
              <i class="fa fa-fw fa-pencil"></i>
              Supplier Reference:
              {{supplierReference}}
            </li>
            <li class="list-group-item">
              <i class="fa fa-fw fa-credit-card"></i>
              Payment Method:
              {{paymentMethod}}
            </li>
            <li class="list-group-item">
              <i class="fa fa-fw fa-{{userCurrency}}"></i>
              Total Price:
              {{decimal totalValue}}
            </li>
            {{#if notes}}
            <li class="list-group-item">
              <i class="fa fa-fw fa-paperclip"></i>
              Notes:
              {{notes}}
            </li>
            {{/if}}
          </ul>
        </div>

        {{> documentContainer collectionName="purchaseorders" id=this._id permissionRequired="CanEditPurchaseOrders"}}

        <div class="panel panel-default">
          <div class="panel-heading">
            {{#if isInRole 'CanEditPurchaseOrders'}}
              <div class="btn-group pull-right">
                <a class="btn btn-primary btn-xs" data-placement="bottom" data-toggle="tooltip" disabled="{{#unless canAddMoreItems}}disabled{{/unless}}" href="#" id="add-item" title="New item for this purchase order">
                  <i class="fa fa-fw fa-plus"></i>
                  Add item</a>
              </div>
            {{/if}}
            Items</div>
          <div class="panel-body">
            <ul class="list-group" id="purchase-order-items">
              {{#if hasItems}}
                {{#each purchaseOrderItems}}
                  {{> purchaseOrderItem}}
                {{/each}}
                {{else}}
                <li class="list-group-item">
                  <em>No items</em>
                </li>
              {{/if}}
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-3"></div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h1 id="activity-timeline">
          Activity Timeline
          <a class="btn btn-primary{{#unless isMobile}} pull-right{{/unless}}" data-placement="bottom" data-toggle="tooltip" href="#" id="add-activity" title="New activity for this purchase order">
            <i class="fa fa-fw fa-plus"></i>
            Add activity</a>
        </h1>
        {{> activityTimeline activities=activities}}
      </div>
    </div>
    {{#if isInRole 'CanEditPurchaseOrders'}}
      {{#if isMobile}}
        <div class="fab edit" id="fab">
          <i class="fa fw-fa fa-pencil"></i>
        </div>
      {{/if}}
    {{/if}}

    {{> autoformModals}}
  {{/with}}
</template>

<template name="purchaseOrderItem">
<li class="list-group-item" id="po-item">
  <div class="row">

    <div class="col-md-3">
      {{description}}
    </div>
    <div class="col-md-2" style="color:#BABABA;">
      {{productCode}}
    </div>
    <div class="col-md-2" style="color:#BABABA;">
      {{projectName}}
    </div>
    <div class="col-md-2">
      <i class="{{statusIcon}}"></i>
      {{orderItemStatus}}
    </div>
    <div class="col-md-1">
      {{decimal totalPrice}}
    </div>
    <div class="col-md-2">
      <div class="btn-group btn-group-justified" role="group">
        <div class="btn-group " role="group">
          <button class="btn btn-xs btn-info" data-placement="bottom" data-toggle="tooltip" disabled="{{#unless canAddMoreItems ..}}disabled{{/unless}}" id="edit-po-item" role="button" title="Edit purchase order item">
            <i class="fa fa-fw fa-pencil"></i>Edit
          </button>
        </div>
        <div class="btn-group" role="group">
          <button class="btn btn-xs btn-danger" data-placement="bottom" data-toggle="tooltip" disabled="{{#unless canAddMoreItems ..}}disabled{{/unless}}" id="removePurchaseOrderItem" role="button" title="Delete purchase order item">
            <i class="fa fa-fw fa-times"></i>Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</li>
</template>

<template name="poHelpModal">
<div class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button aria-hidden="true" class="close" data-dismiss="modal" type="button">Ã—</button>
        <h4>Help on templates</h4>
      </div>
      <div class="modal-body">
        
        <p>Start by creating a Microsoft Word Document to act as a template. Include the keywords below where needed in the document, and select "Microsoft Word Template". In the file finder, select the template file you just created. RealTime will replace the keywords with their relative values, and download a new version of the file for you.</p>
        <p>Keywords which are recognised by RealTime:</p>
        <ul>
          <li>{supplierName} - Supplier company name</li>
          <li>{supplierAddress} - Supplier address</li>
          <li>{supplierReference} - Supplier reference</li>
          <li>{orderNumber} - The purchase order number</li>
          <li>{description} - The date that the template is generated on</li>
          <li>{notes} - Notes against the purchase order</li>
          <li>{paymentMethod} - Payment method of purchase order</li>
          <li>{status} - Status of the purchase order</li>
        </ul>

        For each purchase order item, you can specify the following tags:
        <ul>
          <li>{name} - The name of a purchase order item</li>
          <li>{count} - The number of a purchase order items ordered</li>
          <li>{value} - The value of a purchase order item</li>
          <li>{total} - The total cost of this purchase order item, dependent on quantity</li>
        </ul>
        You can loop through multiple items in your template by wrapping them as follows:
        <blockquote>
          {#items} {name} {count} {value} {total} {/items}
          </blockquote>
          <br /> We can also handle cost displays through the following tags:
          <ul>
            <li>{totalExcVat} - The purchase order total value before VAT</li>
            <li>{vat} - The amount of VAT to pay on this purchase order </li>
            <li>{totalIncVat} - The total purchase order cost including VAT</li>
          </ul>
          <br /> All calculations are carried out by RealTime, so you don't need to do anything extra to generate a Purchase Order.
        </div>
      </div>
    </div>
  </div>
</template>
